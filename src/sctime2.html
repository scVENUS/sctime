<!--
Copyright (C) 2024 The Qt Company Ltd.
SPDX-License-Identifier: LicenseRef-Qt-Commercial OR GPL-3.0-only
-->
<!-- this file was in most parts generated by qt 6.8. But it uses a split wasm archive to increase probability of caching.
 You can either use the autogenerated html from the build, or split
 your wasm file and use this modified html. To split the wasm run for example in a unix shell
 split -d -b 8192k sctime.wasm sctime.wasm.part
 -->

<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <!--Set visual viewport size for mobile devices to the device size,
        witch results in a scale of 1 and a 1:1 mapping between CSS pixels
        and Qt device independent pixels. -->
    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=0"/>

    <title>sctime</title>
    <style>
      /* Make the html body cover the entire (visual) viewport with no scroll bars. */
      html, body { padding: 0; margin: 0; overflow: hidden; height: 100% }
      #screen { width: 100%; height: 100%; }
    </style>
  </head>
  <body onload="init()">
    <figure style="overflow:visible;" id="qtspinner">
      <center style="margin-top:1.5em; line-height:150%">
        <img src="qtlogo.svg" width="320" height="200" style="display:block"></img>
        <strong>Qt for WebAssembly: sctime</strong>
        <div id="qtstatus"></div>
        <noscript>JavaScript is disabled. Please enable JavaScript to use this application.</noscript>
      </center>
    </figure>
    <div id="screen"></div>

    <script type="text/javascript">

        function concatBuf (arraybuffers) {
            let length = 0
            for (const b of arraybuffers)
                length += b.byteLength
          
            let resultbuf = new ArrayBuffer(length)
            let resultuint8 = new Uint8Array(resultbuf)
            let offset = 0
            for (const b of arraybuffers) {
                const partuint8 = new Uint8Array(b)
                resultuint8.set(partuint8, offset)
                offset += partuint8.byteLength
            }
        
            return resultbuf
        }

        async function loadFromParts(url, statusElement) {
            let NUM_PARTS=99
            let idx=0
            let arr=[]
            do {
              let part = await fetch(url+".part"+String(idx).padStart(2, '0'))
              idx++
              let partab= await part.arrayBuffer()
              var ok = (part.status>=200)&& (part.status<300)
              if (ok) {
                  arr.push(partab)
              }
              statusElement.innerHTML+="."
            } while (ok && idx < NUM_PARTS)
            return concatBuf(arr)
        }

        async function init()
        {
            const spinner = document.querySelector('#qtspinner');
            const screen = document.querySelector('#screen');
            const status = document.querySelector('#qtstatus');

            const showUi = (ui) => {
                [spinner, screen].forEach(element => element.style.display = 'none');
                if (screen === ui)
                    screen.style.position = 'default';
                ui.style.display = 'block';
            }

            try {
                showUi(spinner);
                status.innerHTML = 'Loading...';

                ab=await loadFromParts("sctime.wasm", status)

                const wasmPromise = WebAssembly.compile(ab)

                const instance = await qtLoad({
                    qt: {
                        onLoaded: () => showUi(screen),
                        onExit: exitData =>
                        {
                            status.innerHTML = 'Application exit';
                            status.innerHTML +=
                                exitData.code !== undefined ? ` with code ${exitData.code}` : '';
                            status.innerHTML +=
                                exitData.text !== undefined ? ` (${exitData.text})` : '';
                            showUi(spinner);
                        },
                        entryFunction: window.sctime_entry,
                        containerElements: [screen],
                        module: wasmPromise,
                        environment : {},
                        
                    }
                });
            } catch (e) {
                console.error(e);
                console.error(e.stack);
            }
        }
    </script>
    <script src="sctime.js"></script>
    <script type="text/javascript" src="qtloader.js"></script>
  </body>
</html>
